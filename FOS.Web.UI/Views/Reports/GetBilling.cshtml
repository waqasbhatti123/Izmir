@model FOS.Shared.IZHomeData


@{
    ViewBag.Title = "Print Bill";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="http://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css" rel="stylesheet">
<script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
@*<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>*@
<script src="~/Scripts/jquery.sumoselect.js" type="text/javascript"></script>
<link href="~/Content/dropdownliststyle.css" rel="stylesheet" type="text/css" />
<!-- BEGIN PAGE HEADER-->
<div class="row-fluid">
    <div class="span12">
        <h3 class="page-title"></h3>
        <ul class="breadcrumb">
            <li>
                <a href="#">Reports</a>
                <span class="divider">/</span>
            </li>
            <li>
                <a href="#">Print Bill</a>
            </li>
        </ul>
    </div>
</div>
<!-- END PAGE HEADER-->
@using (Ajax.BeginForm("GetPrintBill", "Reports", new AjaxOptions { OnSuccess = "OnSuccess", OnFailure = "OnFailure" }, new { @class = "form-horizontal" }))
{
    @Html.AntiForgeryToken()

    <div class="row-fluid">
        <div class="span12">
            <div class="widget green">
                <div class="widget-title">
                    <h4>Print Bill</h4>
                    <span class="tools"></span>
                </div>
                <div class="widget-body" style="height: 100px;">

                    <div class="span12" style="margin-left:0px">
                        <div class="span3">
                            <div class="control-group">
                                <label class="control-label">Select Block</label>
                                <div class="controls">
                                    @*@Html.DropDownListFor(model => model.TID, new SelectList(Model.Territories, "ID", "TeritoryName"), new {@multiple="multiple", @class = "SlectBox" })*@
                                    @Html.DropDownListFor(model => model.BlockID, new SelectList(Model.Blocks, "ID", "Name"), new { @class = "" })
                                </div>
                            </div>
                        </div>
                        <div class="span3">
                            <div class="control-group">
                                <div class="form-actions" style="padding-left: 10px;">
                                    <button type="submit" id="btnNewww" value="Print" class="btn btn-primary">
                                        <i class="icon-ok icon-white" style="padding-right: 8px"></i><span id="create">Generate Bill</span>
                                    </button>
                                </div>
                            </div>
                            <div class="control-group">
                                <div class="form-actions" style="padding-left: 10px;">
                                    <button type="button" id="btnNewew" value="Print" class="btn btn-primary">
                                        <i class="icon-ok icon-white" style="padding-right: 8px"></i><span id="create">Get Data</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        @*<div class="span7">
                <div class="widget green">
                    <div class="widget-title">
                        <h4>City List</h4>
                    </div>
                    <div class="widget-body" style="padding: 10px; height: 450px; overflow: scroll; background-color: #ebffdf;">
                        <div id="progress" style="display: none; position: absolute; margin-top: 180px; margin-left: 245px;">
                            <h3>Loading . . . </h3>
                        </div>
                        <hr />
                        <div id="painters" class="" style="width: 108%; height: 440px;"></div>
                    </div>
                </div>
            </div>*@
    </div>

}


<div class="row-fluid">
    <div class="span12">
        <div class="span12" style="padding:5px">
            <div id="divPDF">
                <div id="printerDiv"><iframe id="frmPDF"></iframe></div>
            </div>
        </div>
    </div>
</div>


    <div class="row-fluid">
        <div class="span12">
            <!-- BEGIN EXAMPLE TABLE widget-->
            <div class="widget green">
                <div class="widget-title">
                    <h4 class="text-center"><strong>Consumer Bill Detail</strong></h4>
                    <span class="tools">
                        @*<a href="javascript:;" class="icon-chevron-down"></a>*@
                        @*<a href="javascript:;" class="icon-remove"></a>*@
                    </span>
                </div>
                <div class="widget-body">
                    <div>
                        <div class="clearfix">
                            @*<div class="btn-group">
                                <button id="editable-sample_new" class="btn green">
                                    Add New <i class="icon-plus"></i>
                                </button>
                            </div>*@
                            <div class="btn-group pull-right"></div>
                        </div>
                        <div class="space15"></div>
                        <table class="table table-striped table-hover table-bordered" id="datatab" style="width: 100%;">
                            <thead>
                                <tr class="align-center" style="background-color:#1969b1; color:white;">
                                    <th>Sr No</th>
                                    <th>Reference No</th>
                                    <th>Owner Name</th>
                                    <th>Bill Due Date</th>
                                    <th>Payable</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- END EXAMPLE TABLE widget-->
        </div>
    </div>

<script src="~/Scripts/js/sugar.min.js"></script>
<script>
    $("#TID").on("change", function (e) {
        var $TID = $(this).val();
        sPainters = [];
        var $citylist = $("#CID");

         $.ajax({
             url: '@Url.Action("getCities", "Painter")',
            type: "post",
            dataType: 'json',
            data: {
                TID: $TID,
            },
            success: function (json) {
                var $el = $("#painters");
                $el.empty();
                $("#painters").append(json.Response);

            },
            error: function (jxhr) {
                alert("error");
                if (typeof console != 'undefined') {
                    console.log(jxhr.responseText);
                }
            }
         });


     });

    //var a = [];
    var sPainters = [];

    function painterSelected(obj) {


        var painterID = $(obj).attr("data-id");
        var i = findPainter(sPainters, painterID);

        if (obj.checked && i == -1)
        {
            sPainters.push(painterID);
        }

        if (!obj.checked && i > -1)
        {
            sPainters.splice(i,1);
        }
        console.log(sPainters);
    }

    function findPainter(arr, val)
    {
        for (i = 0; i < arr.length ; i++)
        {
            if (arr[i] == val)
            {
                return i;
            }
        }
        return -1;
    }
    @*$('#btnNew').click(function () {
        var message = "";
        for (i = 0; i < sPainters.length ; i++) {
            message += sPainters[i] + ",";
        }
        var $TID = $("#TID").val();
        var $sdate = $("#StartingDate1").val();
        window.open("@Url.Action("GetPrintBill", "Reports")");

    });*@
    $(function () {
        $('#form0').submit(function () {

            $("#City").val($("#PainterCityID").find("option:selected").text());
            $("#SelectedPainters").val(sPainters);
        });

    });


    function LoadPainters(CityName) {
        try {
            $.ajax({
                type: "POST",
                data: { RegionalHeadID: $("#RegionalHeadID").val(), SaleOfficerID: $("#SaleOfficerID").val(), RetailerID: $("#RetailerID").val(), CityName: CityName },
                url: "@Url.Action("LoadPaintersEdit", "Painter")",
                success: function (json) {

                    var $el = $("#painters");
                    $el.empty(); // remove old options
                    $("#painters").append(json.Response);

                    sPainters = [];
                    for (i = 0 ; i < json.PainterIDs.length ; i++)
                    {
                        sPainters.push(json.PainterIDs[i]);
                    }

                    $.each(json.Response, function (value, key) {

                        if (key.Selected == true) {
                            $("#painter" + key.ID + "").attr("checked", true);

                        }
                        else { $("#painter" + key.ID + "").attr("checked", false); }
                    });


                },
                beforeSend: function () {
                    $("#progress").show();
                },
                complete: function () {
                    $("#progress").hide();
                },
                error: function () {
                }

            });
        } catch (e) {
            alert(e);

        }
    }

     function GenerateDetailGrid() {

        //$('#datatab tfoot th').each(function () {
        //    $(this).html('<input type="text" />');
        //});
        var oTable = $('#datatab').DataTable({
            "aLengthMenu": [[10, 25, 50, 75, 100], [10, 25, 50, 75, 100]],
            "iDisplayLength": 10,
            "paging": true,
            "pagingType": "full_numbers",
            "serverSide": true,
            "bRetrieve": true,
            "bDestroy": true,
            "autoWidth": true,
            "ajax":
            {
                "type": "POST",
                "url": '@Url.Action("GetBillingData", "Reports")',
                "contentType": 'application/json; charset=utf-8',
                'data': function (data)
                {
                    data.BlockID = $('#BlockID').val();

                    return data = JSON.stringify(data);

                },

            },
            "fnDrawCallback": function (osetting) {
                $("#btnNewew").click(function () {
                    oTable.clear().draw();
                });
                var UpdateCheck = "0";
                var DeleteCheck = "0";

                if (UpdateCheck == "@HttpContext.Current.Session["UpdateCheck"]") { $(".edit").css("display", "none"); }
                else {
                    $(".edit").on("click", function () {

                        ClearForm();
                        //$('#create').text('Update');
                        $("#divPDF").hide();
                        var CityID = $(this).attr("data-id");

                        try
                        {
                            $.ajax({
                                type: "POST",
                                url: "@Url.Action("GetBillingForReport", "Reports")",
                                data: { CreaID: CityID },

                                success: function (Response) {
                                    debugger;
                                    if (Response != null) {
                                        $('#frmPDF').attr('src', '@Url.Content("~/")' + Response);

                                          setTimeout(function () {
                                              frame = document.getElementById("frmPDF");
                                               framedoc = frame.contentWindow;
                                               framedoc.focus();
                                               framedoc.print();
                                           }, 500);

                                        // $("#RegionID").focus();
                                        //location.reload();
                                    }
                                    else { alertify.error('Server Is Not Responding.'); }
                                }
                            });
                        }
                        catch (ex) { }

                    });
                }

                if (UpdateCheck == "@HttpContext.Current.Session["DeleteCheck"]") { $(".delete").css("display", "none"); }
                    else {
                        $(".delete").on("click", function () {

                            var CityID = $(this).attr("data-id");

                            // confirm dialog
                            alertify.confirm("Are You Sure You Want To Delete This Record ?  ", function (e) {
                                if (e) {

                                    $.ajax({
                                        type: "POST",
                                        url: "@Url.Action("DeleteProjects", "Setup")",
                                        data: { cityID: CityID },
                                        success: function (data) {

                                            if (data == "0") {
                                                alertify.success('Record Deleted Successfully');
                                                var table = $('#datatab').DataTable();
                                                table.row(this).remove().draw(false);
                                            }

                                            else { alertify.error('This City Assign To Someone, First Delete That Then You Can Able To Delete This City.'); }
                                        }

                                    });

                                } else { }
                            });

                        });
                    }

                },
                "fnRowCallback": function (nRow, aData, iDisplayIndex) {
                    $("td:first", nRow).html(iDisplayIndex + 1);
                    return nRow;
                },
                "oLanguage": { "sSearch": "Search Month : " },
                "sDom": 'lftipr',
                "processing": true,
                "deferRender": true,
                "bSelect": true,
                "columns": [
                    { "data": "ID" , "sClass": "center-align-td"},
                    { "data": "ConsumerName", "sClass": "center-align-td"},
                    { "data": "ReferenceNo", "sClass": "center-align-td"},
                    { "data": "BillDueDate", "sClass": "center-align-td"},
                    { "data": "TotalBill", "sClass": "center-align-td"},
               {
                   "sClass": "center-align-td",
                   "mData": null,
                   "bSortable": false,
                   "mRender": function (data, type, row) {
                       return '<button class="btn btn-success edit" data-id=' + row.ID + '>' + '<i class=icon-pencil></i>' + '</button>';
                   }
                    }
               
                ],
                "order": [2, "dec"]

            });

        }


    $(document).ready(function () {

        $('input[name=StartingDate1]').css({ "height": "22px", "width": "202px", "margin-bottom": "0px" });
        $('input[name=StartingDate1]').datepicker({ dateFormat: "MM-yy" });
        $("input[name=StartingDate1]").trigger('change');


        $("#btnN").click(function () {
            alertify.success("Data Receivve");
        });
        $("#divPDF").hide();
        GenerateDetailGrid();



    });


     function ClearForm() {
         $('#ID').val(0);
         $('#Title').val('');
         $('#create').text('Create');
         $("#RegionalHeadID").trigger("change");
         $("#RegionalHeadID").trigger("chosen:update");
         $("#SelectedPainters").val("");
     }

     function OnSuccess(response) {
         if (response == "1") {
             alertify.success("Data Saved Successfully");
             $('#create').text('Create');
             LoadPainters($("#PainterCityID").find("option:selected").text());
             ClearForm();
         }
         else if (response == "2") {
             alertify.error("Please Select Any Painter For Association");
         }
         else if (response == "3") {
             alertify.error("Please Select Any Painter For Association");
         }
         else if (response == "0") {
             alertify.error("Unable To Save Association.");
         }
         else {
             alertify.error(response);
         }

     }

     function OnFailure(response) {
         if (response.status == 422) {
             var errors = JSON.parse(response.responseText);
             alertify.error(errors.errors);
         }
         else {
             alertify.error(response);
         }
     }

</script>
